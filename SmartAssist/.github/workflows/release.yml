# SmartAssist Release Workflow
# Automates versioning, tagging, and release artifact creation

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        lfs: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
    
    - name: Extract version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
    
    - name: Update manifest
      run: |
        python .github/scripts/update_manifest.py ${{ steps.get_version.outputs.version }}
    
    - name: Generate changelog
      id: changelog
      run: |
        python .github/scripts/generate_changelog.py ${{ steps.get_version.outputs.version }} > RELEASE_NOTES.md
    
    - name: Create deployment package
      run: |
        mkdir -p release/smartassist
        
        # Copy source code
        cp -r pipeline release/smartassist/
        cp -r models release/smartassist/
        cp -r services release/smartassist/
        
        # Copy configs (templates)
        cp -r pipeline/config release/smartassist/pipeline/
        cp -r pipeline/deepstream_configs release/smartassist/pipeline/
        
        # Copy documentation
        cp README.md release/smartassist/
        cp CONTRIBUTING.md release/smartassist/
        cp CONFIG_README.md release/smartassist/
        cp LICENSE release/smartassist/
        
        # Copy supporting files
        cp requirements.txt release/smartassist/
        cp manifest.yaml release/smartassist/
        
        # Create tarball
        cd release
        tar -czf smartassist-${{ steps.get_version.outputs.version }}.tar.gz smartassist/
        cd ..
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: SmartAssist v${{ steps.get_version.outputs.version }}
        body_path: RELEASE_NOTES.md
        files: |
          release/smartassist-${{ steps.get_version.outputs.version }}.tar.gz
          manifest.yaml
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        enable_jekyll: false
        cname: docs.smartassist.io
      continue-on-error: true

  notify-deployment:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - name: Send Slack notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'SmartAssist v${{ steps.get_version.outputs.version }} has been released!'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
      continue-on-error: true